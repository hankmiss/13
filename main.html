<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üéÅ ËÅñË™ïÁ¶ÆÁâ©ÊîªÈò≤Êà∞ üéÅ</title>
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;600;700&display=swap" rel="stylesheet">
    
    <style>
        body {
            background-color: #0f172a; /* Slate 900 */
            color: #f1f5f9;
            font-family: 'Fredoka', sans-serif; /* Round, fun font */
            overflow-x: hidden;
            background-image: 
                radial-gradient(circle at 10% 20%, rgba(220, 38, 38, 0.1) 0%, transparent 20%),
                radial-gradient(circle at 90% 80%, rgba(22, 163, 74, 0.1) 0%, transparent 20%);
        }
        
        .glass-panel {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }

        .gift-box {
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            transform-style: preserve-3d;
        }
        
        .gift-box:hover:not(.opened) {
            transform: translateY(-8px) scale(1.05);
            cursor: pointer;
            filter: brightness(1.2);
        }

        .gift-box.opened {
            transform: scale(0.95);
            opacity: 0.8;
            filter: grayscale(0.5);
            cursor: default;
        }

        .modal-overlay {
            animation: fadeIn 0.3s ease-out;
        }

        .modal-content {
            animation: zoomIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes zoomIn {
            from { transform: scale(0.5); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }

        .shimmer {
            position: relative;
            overflow: hidden;
        }
        .shimmer::after {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 50%;
            height: 100%;
            background: linear-gradient(to right, transparent, rgba(255,255,255,0.3), transparent);
            transform: skewX(-20deg);
            animation: shimmer 3s infinite;
        }

        @keyframes shimmer {
            0% { left: -100%; }
            100% { left: 200%; }
        }

        .score-change-float {
            animation: floatUp 1.5s ease-out forwards;
        }
        
        @keyframes floatUp {
            0% { transform: translateY(0); opacity: 1; }
            100% { transform: translateY(-50px); opacity: 0; }
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1e293b; }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #64748b; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- Game Config ---
        const BOX_COUNT = 30;
        
        // Define Box Types
        const BOX_TYPES = [
            { id: 'small_gift', name: 'Âπ∏ÈÅãÁ≥ñÊûú', icon: 'üç¨', desc: 'Áç≤ÂæóÂ∞ëÈáèÂàÜÊï∏', points: 100, weight: 8 },
            { id: 'med_gift', name: 'ËÅñË™ïË•™', icon: 'üß¶', desc: 'Áç≤Âæó‰∏çÈåØÁöÑÂàÜÊï∏', points: 300, weight: 6 },
            { id: 'big_gift', name: 'Ë±™ËèØÁ¶ÆÁõí', icon: 'üéÅ', desc: 'ÈÅãÊ∞£ÁúüÂ•ΩÔºÅÁç≤ÂæóÂ§ßÈáèÂàÜÊï∏', points: 500, weight: 4 },
            { id: 'jackpot', name: 'ËÅñË™ïÂ•áËπü', icon: 'üåü', desc: 'Ë∂ÖÁ¥öÂ§ßÁçéÔºÅÂàÜÊï∏È£õÂ§©‰∫ÜÔºÅ', points: 1000, weight: 1 },
            { id: 'bomb', name: 'Èõ™ÁêÉÁÇ∏ÂΩà', icon: 'üí£', desc: 'Ë¢´Èõ™ÁêÉÁ†∏‰∏≠‰∫ÜÔºÅÊâ£ÂàÜÔºÅ', points: -300, weight: 4 },
            { id: 'big_bomb', name: 'È¶¥ÈπøÁöÑ‰æø‰æø', icon: 'üí©', desc: 'Ë∏©Âà∞Âú∞Èõ∑...ÂàÜÊï∏Ê∏õÂçäÔºÅ', points: 'HALVE', weight: 2 },
            { id: 'thief', name: 'ËÅñË™ïÊÄ™ÂÇë', icon: 'üòà', desc: 'ÂæûÁ¨¨‰∏ÄÂêçË∫´‰∏äÊê∂Ëµ∞ 300 ÂàÜÔºÅ', points: 0, effect: 'STEAL_TOP', weight: 3 },
            { id: 'swap', name: 'Â§ßÈ¢®Âêπ', icon: 'üîÑ', desc: 'ÂíåÊúÄÂæå‰∏ÄÂêç‰∫§ÊèõÂàÜÊï∏ÔºÅ', points: 0, effect: 'SWAP_LAST', weight: 1 },
            { id: 'shield', name: 'ËÅñË™ïË≠∑Áõæ', icon: 'üõ°Ô∏è', desc: 'Áç≤ÂæóË≠∑ÁõæÔºåÂèØÊäµÊìã‰∏ÄÊ¨°Êâ£ÂàÜÊïàÊûú', points: 0, effect: 'GET_SHIELD', weight: 3 },
            { id: 'charity', name: 'ÊÖàÂñÑÂÆ∂', icon: 'ü§≤', desc: 'ÊØè‰ΩçÁé©ÂÆ∂Áç≤Âæó 100 ÂàÜ (‰Ω†‰πüÁç≤Âæó)', points: 0, effect: 'ALL_PLUS_100', weight: 2 },
        ];

        // --- Helper: Generate Weighted Random Box ---
        const generateBoxes = (count) => {
            let boxes = [];
            const totalWeight = BOX_TYPES.reduce((sum, type) => sum + type.weight, 0);
            
            for (let i = 0; i < count; i++) {
                let random = Math.random() * totalWeight;
                let selectedType = BOX_TYPES[0];
                for (let type of BOX_TYPES) {
                    random -= type.weight;
                    if (random <= 0) {
                        selectedType = type;
                        break;
                    }
                }
                boxes.push({
                    id: i,
                    isOpen: false,
                    content: selectedType
                });
            }
            return boxes;
        };

        // --- Main App ---
        const App = () => {
            const [phase, setPhase] = useState('setup'); // setup, game, end
            const [players, setPlayers] = useState([]);
            const [inputName, setInputName] = useState('');
            const [boxes, setBoxes] = useState([]);
            const [currentTurn, setCurrentTurn] = useState(0);
            const [logs, setLogs] = useState([]);
            
            // Modal State
            const [modalData, setModalData] = useState(null); // { type, message, icon, delta }
            const [showModal, setShowModal] = useState(false);

            // --- Handlers ---
            const addPlayer = () => {
                if (!inputName.trim()) return;
                setPlayers([...players, { 
                    id: Date.now(), 
                    name: inputName, 
                    score: 0, 
                    shield: false,
                    history: []
                }]);
                setInputName('');
            };

            const startGame = () => {
                if (players.length < 2) {
                    alert("Ëá≥Â∞ëÈúÄË¶Å 2 ‰ΩçÁé©ÂÆ∂ÊâçËÉΩÈñãÂßãÔºÅ");
                    return;
                }
                setBoxes(generateBoxes(BOX_COUNT));
                setPhase('game');
                addLog("üéÆ ÈÅäÊà≤ÈñãÂßãÔºÅÁ•ùÂ§ßÂÆ∂Â•ΩÈÅãÔºÅ");
            };

            const addLog = (msg) => {
                setLogs(prev => [`[${new Date().toLocaleTimeString('zh-TW', {hour12:false, hour:"2-digit", minute:"2-digit"})}] ${msg}`, ...prev]);
            };

            const handleBoxClick = (boxIndex) => {
                if (boxes[boxIndex].isOpen || showModal) return;

                const box = boxes[boxIndex];
                const currentPlayer = players[currentTurn];
                let newPlayers = [...players];
                let player = newPlayers[currentTurn];
                let modalInfo = { ...box.content, title: box.content.name, delta: 0 };

                // Open Box Logic
                const updatedBoxes = [...boxes];
                updatedBoxes[boxIndex].isOpen = true;
                setBoxes(updatedBoxes);

                // --- Apply Effects ---
                let logMsg = `${player.name} ÊâìÈñã‰∫ÜÁÆ±Â≠ê...`;

                if (box.content.points !== 0 && typeof box.content.points === 'number') {
                    // Normal Points
                    let points = box.content.points;
                    
                    // Shield Check for Negative Points
                    if (points < 0 && player.shield) {
                        points = 0;
                        player.shield = false;
                        modalInfo.desc = "Ë≠∑ÁõæÊäµÊìã‰∫ÜÁÇ∏ÂΩàÊîªÊìäÔºÅÊØ´È´ÆÁÑ°ÂÇ∑ÔºÅ";
                        logMsg += ` Ëß∏Áôº ${box.content.name}Ôºå‰ΩÜË≠∑ÁõæÊäµÊìã‰∫ÜÂÇ∑ÂÆ≥ÔºÅ`;
                    } else {
                        player.score += points;
                        modalInfo.delta = points;
                        logMsg += ` Ëß∏Áôº ${box.content.name}Ôºå${points > 0 ? 'Áç≤Âæó' : 'Êâ£Èô§'} ${Math.abs(points)} ÂàÜÔºÅ`;
                    }
                } 
                else if (box.content.points === 'HALVE') {
                    // Halve Points
                    if (player.shield) {
                        player.shield = false;
                        modalInfo.desc = "Ë≠∑ÁõæÊäµÊìã‰∫Ü‰æø‰æøÊîªÊìäÔºÅÂàÜÊï∏‰øù‰Ωè‰∫ÜÔºÅ";
                        logMsg += ` Â∑ÆÈªûË∏©Âà∞‰æø‰æøÔºåÂπ∏Â•ΩÊúâË≠∑ÁõæÔºÅ`;
                    } else {
                        const lost = Math.floor(player.score / 2);
                        player.score -= lost;
                        modalInfo.delta = -lost;
                        modalInfo.desc = `Â§™ÊÖò‰∫Ü...ÂàÜÊï∏Áõ¥Êé•Ê∏õÂçä (-${lost})`;
                        logMsg += ` Ë∏©Âà∞Âú∞Èõ∑ÔºåÂàÜÊï∏Ê∏õÂçäÔºÅ`;
                    }
                }
                else if (box.content.effect === 'GET_SHIELD') {
                    player.shield = true;
                    logMsg += ` Áç≤Âæó‰∫ÜË≠∑ÁõæÔºÅ`;
                }
                else if (box.content.effect === 'STEAL_TOP') {
                    // Find Top Player (not self)
                    const others = newPlayers.filter(p => p.id !== player.id);
                    if (others.length > 0) {
                        const victim = others.reduce((prev, current) => (prev.score > current.score) ? prev : current);
                        const stealAmount = Math.min(300, victim.score); // Can't steal negative
                        
                        // Victim loses
                        const victimIndex = newPlayers.findIndex(p => p.id === victim.id);
                        if (newPlayers[victimIndex].shield) {
                            newPlayers[victimIndex].shield = false;
                            modalInfo.desc = `${victim.name} ÁöÑË≠∑ÁõæÊìã‰Ωè‰∫Ü‰Ω†ÁöÑÊê∂Â•™ÔºÅ`;
                            logMsg += ` ÊÉ≥Êê∂Âä´ ${victim.name}Ôºå‰ΩÜË¢´Ë≠∑ÁõæÊìã‰Ωè‰∫ÜÔºÅ`;
                        } else {
                            newPlayers[victimIndex].score -= stealAmount;
                            player.score += stealAmount;
                            modalInfo.delta = stealAmount;
                            modalInfo.desc = `ÂæûÁ¨¨‰∏ÄÂêç ${victim.name} Ë∫´‰∏äÊê∂Ëµ∞‰∫Ü ${stealAmount} ÂàÜÔºÅ`;
                            logMsg += ` Êê∂Âä´‰∫Ü ${victim.name} ${stealAmount} ÂàÜÔºÅ`;
                        }
                    } else {
                        modalInfo.desc = "Â†¥‰∏äÊ≤í‰∫∫ÂèØÊê∂...Â•ΩÂ∞∑Â∞¨„ÄÇ";
                    }
                }
                else if (box.content.effect === 'SWAP_LAST') {
                    // Find Last Player
                    const others = newPlayers.filter(p => p.id !== player.id);
                    if (others.length > 0) {
                        const victim = others.reduce((prev, current) => (prev.score < current.score) ? prev : current);
                        const victimIndex = newPlayers.findIndex(p => p.id === victim.id);
                        
                        const myScore = player.score;
                        const theirScore = newPlayers[victimIndex].score;
                        
                        player.score = theirScore;
                        newPlayers[victimIndex].score = myScore;
                        
                        modalInfo.desc = `ÂëΩÈÅãÂ§ßÈÄÜËΩâÔºÅ‰Ω†ÂíåÊúÄÂæå‰∏ÄÂêç ${victim.name} ‰∫§Êèõ‰∫ÜÂàÜÊï∏ÔºÅ`;
                        logMsg += ` Âíå ${victim.name} ‰∫§Êèõ‰∫ÜÈùàÈ≠ÇÔºàÂàÜÊï∏ÔºâÔºÅ`;
                    }
                }
                else if (box.content.effect === 'ALL_PLUS_100') {
                    newPlayers.forEach(p => p.score += 100);
                    modalInfo.desc = "ÊôÆÂ§©ÂêåÊÖ∂ÔºÅÊØèÂÄã‰∫∫ÈÉΩÁç≤Âæó 100 ÂàÜÔºÅ";
                    logMsg += ` ÁôºÂãïÊÖàÂñÑÔºåÂÖ®Âì°Âä†ÂàÜÔºÅ`;
                }

                setPlayers(newPlayers);
                addLog(logMsg);
                setModalData(modalInfo);
                setShowModal(true);
            };

            const closeModal = () => {
                setShowModal(false);
                // Next turn
                // Check if all boxes opened
                if (boxes.every(b => b.isOpen)) {
                    setPhase('end');
                    addLog("üèÅ ÈÅäÊà≤ÁµêÊùüÔºÅÊü•ÁúãÊúÄÁµÇÊéíÂêçÔºÅ");
                } else {
                    setCurrentTurn((currentTurn + 1) % players.length);
                }
            };

            const resetGame = () => {
                if (confirm("Á¢∫ÂÆöË¶ÅÈáçÊñ∞ÈñãÂßãÂóéÔºüÁé©ÂÆ∂Ë≥áÊñôÊúÉ‰øùÁïôÔºå‰ΩÜÂàÜÊï∏ÊúÉÈáçÁΩÆ„ÄÇ")) {
                    setPlayers(players.map(p => ({ ...p, score: 0, shield: false })));
                    setBoxes([]);
                    setPhase('setup');
                    setLogs([]);
                }
            };

            // --- Render Components ---

            const SetupScreen = () => (
                <div className="flex flex-col items-center justify-center min-h-[80vh] animate-[pop_0.5s_ease-out]">
                    <div className="glass-panel p-10 rounded-3xl max-w-2xl w-full text-center">
                        <h1 className="text-6xl font-black mb-6 text-transparent bg-clip-text bg-gradient-to-r from-red-400 to-green-400 drop-shadow-lg">
                            ËÅñË™ïÁ¶ÆÁâ©ÊîªÈò≤Êà∞
                        </h1>
                        <p className="text-gray-300 mb-8 text-xl">Á¥îÈù†ÈÅãÊ∞£ ‚úñ ‰∫íÁõ∏ÂÇ∑ÂÆ≥ ‚úñ ÂèãÊÉÖÁ†¥Â£û</p>
                        
                        <div className="flex gap-4 mb-8">
                            <input 
                                type="text" 
                                value={inputName}
                                onChange={e => setInputName(e.target.value)}
                                onKeyDown={e => e.key === 'Enter' && addPlayer()}
                                placeholder="Ëº∏ÂÖ•Áé©ÂÆ∂ÂêçÂ≠ó..."
                                className="flex-1 bg-slate-800 border-2 border-slate-600 rounded-xl px-4 py-3 text-xl focus:border-green-500 focus:outline-none transition"
                            />
                            <button 
                                onClick={addPlayer}
                                className="bg-green-600 hover:bg-green-500 text-white px-8 py-3 rounded-xl font-bold text-xl transition shadow-lg hover:shadow-green-500/50"
                            >
                                Âä†ÂÖ•
                            </button>
                        </div>

                        <div className="bg-slate-800/50 rounded-xl p-4 min-h-[200px] max-h-[300px] overflow-y-auto mb-8 text-left">
                            <h3 className="text-gray-400 text-sm font-bold mb-2 sticky top-0 bg-slate-800/90 p-2">Â∑≤Âä†ÂÖ•Áé©ÂÆ∂ ({players.length})</h3>
                            <div className="flex flex-wrap gap-2">
                                {players.map(p => (
                                    <span key={p.id} className="bg-slate-700 px-3 py-1 rounded-full text-lg animate-[zoomIn_0.3s]">
                                        {p.name}
                                    </span>
                                ))}
                                {players.length === 0 && <span className="text-gray-500 italic p-2">Á≠âÂæÖÁé©ÂÆ∂Âä†ÂÖ•...</span>}
                            </div>
                        </div>

                        <button 
                            onClick={startGame}
                            className="w-full bg-gradient-to-r from-red-600 to-red-500 hover:from-red-500 hover:to-red-400 text-white py-4 rounded-2xl font-black text-2xl shadow-xl transition transform hover:scale-[1.02] active:scale-95"
                        >
                            ÈñãÂßãÂ§ß‰∫ÇÈ¨•ÔºÅ üöÄ
                        </button>
                    </div>
                </div>
            );

            const GameScreen = () => {
                const currentPlayer = players[currentTurn];
                const sortedPlayers = [...players].sort((a, b) => b.score - a.score);

                return (
                    <div className="max-w-7xl mx-auto p-4 flex flex-col lg:flex-row gap-6 h-[95vh]">
                        {/* Left: Leaderboard & Status */}
                        <div className="lg:w-1/4 flex flex-col gap-4">
                            {/* Current Turn Card */}
                            <div className="glass-panel p-6 rounded-2xl border-l-4 border-yellow-400 shimmer">
                                <h3 className="text-gray-400 text-sm font-bold uppercase tracking-wider mb-1">ÁèæÂú®Ëº™Âà∞</h3>
                                <div className="text-4xl font-black text-yellow-400 truncate">{currentPlayer.name}</div>
                                {currentPlayer.shield && (
                                    <div className="mt-2 text-blue-300 text-sm flex items-center gap-2 bg-blue-900/30 p-1 rounded">
                                        <i className="fa-solid fa-shield-halved"></i> Ë≠∑ÁõæÈò≤Á¶¶‰∏≠
                                    </div>
                                )}
                                <div className="mt-2 text-gray-300">ÁõÆÂâçÂàÜÊï∏: <span className="font-mono text-xl">{currentPlayer.score}</span></div>
                            </div>

                            {/* Leaderboard */}
                            <div className="glass-panel rounded-2xl flex-1 overflow-hidden flex flex-col">
                                <div className="p-4 bg-slate-800/80 font-bold border-b border-gray-700 flex justify-between items-center">
                                    <span>üèÜ Âç≥ÊôÇÊà∞Ê≥Å</span>
                                    <span className="text-xs text-gray-400">Top Players</span>
                                </div>
                                <div className="overflow-y-auto p-2 space-y-2 flex-1">
                                    {sortedPlayers.map((p, idx) => (
                                        <div key={p.id} className={`flex items-center justify-between p-3 rounded-xl transition-all ${p.id === currentPlayer.id ? 'bg-yellow-500/20 border border-yellow-500/50' : 'bg-slate-800/50'}`}>
                                            <div className="flex items-center gap-3">
                                                <div className={`w-8 h-8 rounded-full flex items-center justify-center font-bold ${idx === 0 ? 'bg-yellow-400 text-black' : idx === 1 ? 'bg-gray-300 text-black' : idx === 2 ? 'bg-amber-600 text-white' : 'bg-slate-700'}`}>
                                                    {idx + 1}
                                                </div>
                                                <div>
                                                    <div className="font-bold">{p.name}</div>
                                                    {p.shield && <i className="fa-solid fa-shield text-xs text-blue-400" title="ÊúâË≠∑Áõæ"></i>}
                                                </div>
                                            </div>
                                            <div className={`font-mono font-bold text-lg ${p.score < 0 ? 'text-red-400' : 'text-green-400'}`}>
                                                {p.score}
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </div>

                            {/* Game Log */}
                            <div className="glass-panel rounded-2xl h-48 overflow-hidden flex flex-col">
                                <div className="p-2 bg-slate-800/80 text-xs font-bold uppercase tracking-wide text-gray-500">
                                    Êà∞È¨•Á¥ÄÈåÑ
                                </div>
                                <div className="p-3 overflow-y-auto space-y-2 flex-1 font-mono text-xs text-gray-300">
                                    {logs.map((log, i) => (
                                        <div key={i} className="border-b border-gray-800 pb-1">{log}</div>
                                    ))}
                                </div>
                            </div>
                        </div>

                        {/* Right: Gift Grid */}
                        <div className="lg:w-3/4 glass-panel rounded-3xl p-6 overflow-y-auto">
                            <div className="grid grid-cols-4 sm:grid-cols-5 md:grid-cols-6 gap-4 h-full content-start">
                                {boxes.map((box, idx) => (
                                    <div 
                                        key={box.id}
                                        onClick={() => handleBoxClick(idx)}
                                        className={`gift-box aspect-square rounded-2xl flex items-center justify-center relative shadow-lg
                                            ${box.isOpen 
                                                ? 'bg-slate-800 opened border border-slate-700' 
                                                : 'bg-gradient-to-br from-red-600 to-red-800 border-2 border-red-400'
                                            }`}
                                    >
                                        {!box.isOpen ? (
                                            <>
                                                <div className="absolute inset-0 bg-[url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI4IiBoZWlnaHQ9IjgiPgo8cmVjdCB3aWR0aD0iOCIgaGVpZ2h0PSI4IiBmaWxsPSIjZmZmIiBmaWxsLW9wYWNpdHk9IjAuMSIvPgo8cGF0aCBkPSJNMCAwTDggOFpNOCAwTDAgOFoiIHN0cm9rZT0iI2ZmZiIgc3Ryb2tlLW9wYWNpdHk9IjAuMSIvPjwvc3ZnPg==')] opacity-30"></div>
                                                <div className="z-10 text-4xl drop-shadow-md filter drop-shadow-lg">üéÅ</div>
                                                <div className="absolute bottom-2 right-2 text-red-200 font-mono text-sm opacity-50">{idx + 1}</div>
                                                {/* Ribbon CSS */}
                                                <div className="absolute inset-0 flex items-center justify-center pointer-events-none">
                                                    <div className="w-full h-1/5 bg-yellow-400 shadow-sm"></div>
                                                    <div className="absolute h-full w-1/5 bg-yellow-400 shadow-sm"></div>
                                                </div>
                                            </>
                                        ) : (
                                            <div className="flex flex-col items-center animate-[zoomIn_0.3s]">
                                                <div className="text-4xl mb-1">{box.content.icon}</div>
                                                <div className={`font-black text-sm text-center px-1 leading-tight ${
                                                    box.content.points < 0 ? 'text-red-400' : 
                                                    box.content.points > 0 ? 'text-green-400' : 'text-blue-400'
                                                }`}>
                                                    {typeof box.content.points === 'number' && box.content.points !== 0 ? (
                                                        <span>{box.content.points > 0 ? '+' : ''}{box.content.points}</span>
                                                    ) : (
                                                        <span className="text-xs">{box.content.name}</span>
                                                    )}
                                                </div>
                                            </div>
                                        )}
                                    </div>
                                ))}
                            </div>
                        </div>
                    </div>
                );
            };

            const EndScreen = () => {
                const sortedPlayers = [...players].sort((a, b) => b.score - a.score);
                
                return (
                    <div className="flex flex-col items-center justify-center min-h-screen p-4 animate-[pop_0.5s]">
                        <h1 className="text-5xl font-black mb-8 text-yellow-400 uppercase tracking-widest drop-shadow-xl">
                            üèÜ ÊúÄÁµÇÊéíÂêç üèÜ
                        </h1>
                        
                        <div className="w-full max-w-4xl space-y-4">
                            {sortedPlayers.map((p, idx) => (
                                <div key={p.id} className={`glass-panel p-6 rounded-2xl flex items-center justify-between transform transition hover:scale-105 ${
                                    idx === 0 ? 'bg-gradient-to-r from-yellow-600/50 to-yellow-900/50 border-yellow-400' :
                                    idx === 1 ? 'bg-gradient-to-r from-gray-500/50 to-gray-700/50 border-gray-400' :
                                    idx === 2 ? 'bg-gradient-to-r from-orange-600/50 to-orange-800/50 border-orange-400' : ''
                                }`}>
                                    <div className="flex items-center gap-6">
                                        <div className={`w-16 h-16 rounded-full flex items-center justify-center text-3xl font-black ${
                                            idx === 0 ? 'bg-yellow-400 text-black shadow-[0_0_20px_rgba(250,204,21,0.5)]' :
                                            idx === 1 ? 'bg-gray-300 text-black' :
                                            idx === 2 ? 'bg-orange-500 text-white' : 'bg-slate-700 text-gray-400'
                                        }`}>
                                            {idx + 1}
                                        </div>
                                        <div>
                                            <div className="text-3xl font-bold">{p.name}</div>
                                            <div className="text-sm text-gray-400">ÊåëÈÅ∏Á¶ÆÁâ©È†Ü‰Ωç: Á¨¨ {idx + 1} ‰Ωç</div>
                                        </div>
                                    </div>
                                    <div className="text-4xl font-mono font-bold text-white">
                                        {p.score} <span className="text-sm text-gray-500">ÂàÜ</span>
                                    </div>
                                </div>
                            ))}
                        </div>

                        <button 
                            onClick={resetGame}
                            className="mt-12 bg-slate-700 hover:bg-slate-600 px-8 py-3 rounded-xl font-bold transition"
                        >
                            ÈáçÊñ∞ÈñãÂßã‰∏ÄÂ±Ä
                        </button>
                    </div>
                );
            };

            // --- Modal Component ---
            const EventModal = () => {
                if (!showModal || !modalData) return null;

                return (
                    <div className="fixed inset-0 z-50 flex items-center justify-center p-4 modal-overlay bg-black/80 backdrop-blur-sm" onClick={closeModal}>
                        <div className="modal-content bg-slate-800 border-2 border-white/20 p-10 rounded-3xl max-w-lg w-full text-center shadow-2xl relative overflow-hidden" onClick={e => e.stopPropagation()}>
                            {/* Background decoration */}
                            <div className="absolute top-0 left-0 w-full h-32 bg-gradient-to-b from-white/10 to-transparent pointer-events-none"></div>

                            <div className="text-8xl mb-6 animate-bounce">
                                {modalData.icon}
                            </div>
                            
                            <h2 className="text-4xl font-black mb-4 text-white drop-shadow-md">
                                {modalData.title}
                            </h2>
                            
                            <p className="text-2xl text-gray-300 mb-8 leading-relaxed">
                                {modalData.desc}
                            </p>

                            {modalData.delta !== 0 && (
                                <div className={`text-5xl font-mono font-bold mb-8 ${modalData.delta > 0 ? 'text-green-400' : 'text-red-400'}`}>
                                    {modalData.delta > 0 ? '+' : ''}{modalData.delta}
                                </div>
                            )}

                            <button 
                                onClick={closeModal}
                                className="w-full bg-white text-slate-900 font-black text-xl py-4 rounded-xl hover:bg-gray-200 transition transform hover:scale-[1.02]"
                            >
                                Áü•ÈÅì‰∫ÜÔºÅ
                            </button>
                        </div>
                    </div>
                );
            };

            return (
                <div className="min-h-screen text-white relative">
                   {/* Background Snow (CSS only) */}
                   <div className="fixed inset-0 pointer-events-none opacity-20 bg-[url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI1MCIgaGVpZ2h0PSI1MCI+CjxjaXJjbGUgY3g9IjI1IiBjeT0iMjUiIHI9IjEiIGZpbGw9IiNmZmYiLz4KPC9zdmc+')]"></div>

                   {phase === 'setup' && <SetupScreen />}
                   {phase === 'game' && <GameScreen />}
                   {phase === 'end' && <EndScreen />}
                   
                   <EventModal />
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
